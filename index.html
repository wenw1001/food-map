<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ± éš¨æ©Ÿç¾é£Ÿå°èˆªå“¡ | Premium</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF4757;
            --secondary: #2F3542;
            --accent: #ffa502;
            --bg: #F1F2F6;
        }

        body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--secondary); }
        header { background: var(--primary); color: white; padding: 40px 20px; text-align: center; border-radius: 0 0 30px 30px; box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3); }
        .container { max-width: 650px; margin: -30px auto 50px; padding: 0 15px; }
        .card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        .section-title { font-size: 1rem; font-weight: bold; margin: 20px 0 10px; color: #57606f; display: block; border-left: 4px solid var(--primary); padding-left: 10px; }
        
        /* Chips é¸é …æ¨£å¼ */
        .chip-group { display: flex; flex-wrap: wrap; gap: 8px; }
        .chip-group input { display: none; }
        .chip-group label {
            padding: 8px 16px; border-radius: 50px; background: #f0f0f0; 
            cursor: pointer; font-size: 0.9rem; transition: 0.3s; border: 1.5px solid transparent;
        }
        .chip-group input:checked + label { background: #ffeae6; color: var(--primary); border-color: var(--primary); font-weight: bold; }

        .action-btn {
            width: 100%; padding: 18px; border: none; border-radius: 15px;
            background: var(--primary); color: white; font-size: 1.3rem; font-weight: bold;
            cursor: pointer; margin-top: 25px; transition: 0.3s;
        }
        .action-btn:hover { background: #ff6b81; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255, 71, 87, 0.4); }

        /* çµæœé¡¯ç¤º */
        .place-item { background: white; border-radius: 20px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .place-content { display: flex; padding: 15px; gap: 15px; }
        .place-map-box { width: 130px; height: 130px; flex-shrink: 0; border-radius: 15px; overflow: hidden; background: #eee; }
        .place-map-box img { width: 100%; height: 100%; object-fit: cover; }
        
        .place-details { flex-grow: 1; }
        .place-name { font-size: 1.2rem; font-weight: bold; margin: 0; color: var(--secondary); }
        .route-summary { font-size: 0.85rem; background: #fffaf0; padding: 8px; border-radius: 10px; margin: 8px 0; border: 1px solid #ffeaa7; }
        
        .directions-box { padding: 0 15px 15px; border-top: 1px dashed #ddd; font-size: 0.85rem; color: #57606f; display: none; background: #fafafa; }
        .step-item { margin: 10px 0; padding-left: 20px; position: relative; line-height: 1.4; }
        .step-item::before { content: "ğŸ“"; position: absolute; left: 0; font-size: 0.8rem; }
        
        .toggle-route { color: var(--primary); cursor: pointer; font-size: 0.85rem; font-weight: bold; margin-top: 5px; display: inline-block; }

        .loading { text-align: center; padding: 20px; display: none; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<header>
    <h1>ğŸ• ç¾é£Ÿæ¢éšªç‰¹æ´¾å“¡</h1>
    <p>è‡ªè¨‚é ç®—ã€æ™‚æ®µèˆ‡äº¤é€šï¼Œéš¨æ©Ÿé‡è¦‹ç¾å‘³</p>
</header>

<div class="container">
    <div class="card">
        <span class="section-title">â° ç”¨é¤æ™‚æ®µ</span>
        <div class="chip-group">
            <input type="radio" id="s1" name="period" value="æ—©é¤"><label for="s1">æ—©é¤</label>
            <input type="radio" id="s2" name="period" value="åˆé¤"><label for="s2">åˆé¤</label>
            <input type="radio" id="s3" name="period" value="æ™šé¤" checked><label for="s3">æ™šé¤</label>
            <input type="radio" id="s4" name="period" value="å®µå¤œ"><label for="s4">å®µå¤œ</label>
            <input type="radio" id="s5" name="period" value="é»å¿ƒ"><label for="s5">é»å¿ƒ/ä¸‹åˆèŒ¶</label>
        </div>

        <span class="section-title">ğŸ› æƒ³åƒä»€éº¼ï¼Ÿ(å¯å¤šé¸)</span>
        <div class="chip-group">
            <input type="checkbox" id="f1" name="food" value="ç«é‹" checked><label for="f1">ç«é‹</label>
            <input type="checkbox" id="f2" name="food" value="ç‡’è‚‰"><label for="f2">ç‡’è‚‰</label>
            <input type="checkbox" id="f3" name="food" value="æ‹‰éºµ"><label for="f3">æ‹‰éºµ</label>
            <input type="checkbox" id="f4" name="food" value="ç¾©å¤§åˆ©éºµ"><label for="f4">ç¾©å¼</label>
            <input type="checkbox" id="f5" name="food" value="å£½å¸ æ—¥å¼"><label for="f5">æ—¥æ–™</label>
            <input type="checkbox" id="f6" name="food" value="ç¾å¼ æ¼¢å ¡"><label for="f6">ç¾å¼</label>
            <input type="checkbox" id="f7" name="food" value="å’–å•¡å»³"><label for="f7">å’–å•¡å»³</label>
            <input type="checkbox" id="f8" name="food" value="å°å¼ å‚³çµ±ç¾é£Ÿ"><label for="f8">å°å¼</label>
            <input type="checkbox" id="f9" name="food" value="éŸ“å¼æ–™ç†"><label for="f9">éŸ“å¼</label>
            <input type="checkbox" id="f10" name="food" value="æ³°å¼æ–™ç†"><label for="f10">æ³°å¼</label>
        </div>

        <span class="section-title">ğŸ’° é ç®—åƒ¹ä½</span>
        <div class="chip-group">
            <input type="radio" id="p1" name="budget" value="1"><label for="p1">200å…ƒå…§</label>
            <input type="radio" id="p2" name="budget" value="2" checked><label for="p2">300-500å…ƒ</label>
            <input type="radio" id="p3" name="budget" value="3"><label for="p3">500-1000å…ƒ</label>
            <input type="radio" id="p4" name="budget" value="4"><label for="p4">1000å…ƒä»¥ä¸Š</label>
        </div>

        <span class="section-title">ğŸš‡ äº¤é€šæ–¹å¼</span>
        <div class="chip-group">
            <input type="radio" id="m1" name="mode" value="WALKING"><label for="m1">ğŸš¶ èµ°è·¯</label>
            <input type="radio" id="m2" name="mode" value="BICYCLING" checked><label for="m2">ğŸš² é¨è»Š</label>
            <input type="radio" id="m3" name="mode" value="TRANSIT"><label for="m3">ğŸšŒ å¤§çœ¾é‹è¼¸</label>
        </div>

        <button class="action-btn" onclick="searchFood()">ğŸš€ å¹«æˆ‘æ±ºå®šä¸¦è¦åŠƒè·¯ç·š</button>
    </div>

    <div id="loading" class="loading">ğŸ“¡ æ­£åœ¨æœå°‹ç¬¦åˆé ç®—çš„ç¾å‘³åº—å®¶...</div>
    <div id="results"></div>
    <button id="more-btn" style="display:none; width:100%; padding:15px; border:none; background:none; color:var(--primary); font-weight:bold; cursor:pointer;" onclick="displayBatch()">â¬‡ é¡¯ç¤ºæ›´å¤šéš¨æ©Ÿæ¨è–¦</button>
</div>

<script>
    (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
        key: "AIzaSyAX02p-zEZMVHrIm3Lq-4WhC2EKr5pEki8", // âš ï¸ å‹™å¿…æ›¿æ›
        v: "weekly"
    });
</script>

<script>
    let userPos, placeLib, directionsService;
    let pool = [];
    let currentIndex = 0;
    const apiKey = "AIzaSyAX02p-zEZMVHrIm3Lq-4WhC2EKr5pEki8"; // âš ï¸ å‹™å¿…æ›¿æ›

    async function searchFood() {
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const moreBtn = document.getElementById('more-btn');
        
        loading.style.display = 'block';
        results.innerHTML = '';
        pool = [];
        currentIndex = 0;
        moreBtn.style.display = 'none';

        if (!placeLib) placeLib = await google.maps.importLibrary("places");
        if (!directionsService) directionsService = new google.maps.DirectionsService();

        navigator.geolocation.getCurrentPosition(async (pos) => {
            userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            
            const period = document.querySelector('input[name="period"]:checked').value;
            const foods = Array.from(document.querySelectorAll('input[name="food"]:checked')).map(el => el.value);
            const budget = parseInt(document.querySelector('input[name="budget"]:checked').value);
            const mode = document.querySelector('input[name="mode"]:checked').value;
            
            // æ§‹å»ºç²¾æº–çš„ Text Query
            const textQuery = `${period} ${foods.join(" ")}`;
            
            let radius = (mode === "WALKING") ? 1000 : (mode === "BICYCLING" ? 5000 : 15000);

            const { Place, PriceLevel } = placeLib;
            
            const request = {
                textQuery: textQuery,
                locationBias: { center: userPos, radius: radius },
                isOpenNow: true,
                priceLevels: [budget], // å°æ‡‰ Google API çš„ 0-4 ç´š
                fields: ['displayName', 'location', 'rating', 'id', 'userRatingCount'],
                language: 'zh-TW'
            };

            try {
                const { places } = await Place.searchByText(request);
                if (!places || places.length === 0) throw "ç„¡çµæœ";
                
                // éš¨æ©Ÿæ‰“äº‚ä¸¦å„²å­˜
                pool = places.sort(() => Math.random() - 0.5);
                displayBatch();
            } catch (e) {
                console.error(e);
                alert("ğŸ¥º æ‰¾ä¸åˆ°ç¬¦åˆé€™äº›é ç®—èˆ‡æ¢ä»¶çš„ç‡Ÿæ¥­ä¸­é¤å»³ï¼Œè«‹è©¦è‘—æ”¾å¯¬æ¢ä»¶ï¼ˆä¾‹å¦‚å¢åŠ é£Ÿç‰©é¡å‹æˆ–èª¿æ•´é ç®—ï¼‰ã€‚");
                loading.style.display = 'none';
            }
        });
    }

    async function displayBatch() {
        const loading = document.getElementById('loading');
        const moreBtn = document.getElementById('more-btn');
        const mode = document.querySelector('input[name="mode"]:checked').value;
        const batch = pool.slice(currentIndex, currentIndex + 3);

        for (const place of batch) {
            await getRouteData(place, mode);
        }

        currentIndex += 3;
        loading.style.display = 'none';
        if (currentIndex < pool.length) moreBtn.style.display = 'block';
    }

    async function getRouteData(place, mode) {
        return new Promise((resolve) => {
            directionsService.route({
                origin: userPos,
                destination: place.location,
                travelMode: google.maps.TravelMode[mode]
            }, (result, status) => {
                if (status === 'OK') {
                    renderCard(place, result.routes[0].legs[0]);
                }
                resolve();
            });
        });
    }

    function renderCard(place, leg) {
        const container = document.getElementById('results');
        const cardId = `route-${place.id}`;
        
        const path = `path=color:0xff4757ff|weight:5|${userPos.lat},${userPos.lng}|${place.location.lat()},${place.location.lng()}`;
        const mapUrl = `https://maps.googleapis.com/maps/api/staticmap?size=260x260&markers=color:blue|label:S|${userPos.lat},${userPos.lng}&markers=color:red|label:E|${place.location.lat()},${place.location.lng()}&${path}&key=${apiKey}`;

        const stepsHtml = leg.steps.map(step => `<div class="step-item">${step.instructions} (${step.distance.text})</div>`).join('');

        const html = `
            <div class="place-item">
                <div class="place-content">
                    <div class="place-map-box">
                        <img src="${mapUrl}">
                    </div>
                    <div class="place-details">
                        <h3 class="place-name">${place.displayName}</h3>
                        <div style="color:var(--accent); font-weight:bold; margin-top:5px;">â˜… ${place.rating || 'æ–°åº—'} <span style="font-weight:normal; color:#999; font-size:0.8rem">(${place.userRatingCount || 0})</span></div>
                        <div class="route-summary">
                            â±ï¸ <b>${leg.duration.text}</b> (${leg.distance.text})<br>
                            ğŸ‘£ å»ºè­°ï¼š${getModeIcon()}
                        </div>
                        <div class="toggle-route" onclick="toggleRoute('${cardId}', this)">å±•é–‹å…·é«”è·¯ç·š â–¼</div>
                    </div>
                </div>
                <div id="${cardId}" class="directions-box">
                    <p style="margin-bottom:5px;"><b>è©³ç´°æŒ‡å¼•ï¼š</b></p>
                    ${stepsHtml}
                    <a href="https://www.google.com/maps/dir/?api=1&origin=${userPos.lat},${userPos.lng}&destination=${place.displayName}&destination_place_id=${place.id}&travelmode=${document.querySelector('input[name="mode"]:checked').value.toLowerCase()}" 
                       target="_blank" style="display:block; margin-top:15px; color:var(--primary); font-weight:bold; text-decoration:none; text-align:center; border:1px solid var(--primary); padding:8px; border-radius:10px;">åœ¨ Google Maps ä¸­å°èˆª â”</a>
                </div>
            </div>
        `;
        container.innerHTML += html;
    }

    function toggleRoute(id, btn) {
        const box = document.getElementById(id);
        if(box.style.display === 'block') {
            box.style.display = 'none';
            btn.innerText = 'å±•é–‹å…·é«”è·¯ç·š â–¼';
        } else {
            box.style.display = 'block';
            btn.innerText = 'æ”¶åˆè·¯ç·š â–²';
        }
    }

    function getModeIcon() {
        const mode = document.querySelector('input[name="mode"]:checked').value;
        if (mode === 'WALKING') return "æ­¥è¡Œå‰å¾€";
        if (mode === 'BICYCLING') return "é¨å–®è»Š/æ©Ÿè»Š";
        return "æ­ä¹˜å¤§çœ¾é‹è¼¸";
    }
</script>

</body>
</html>