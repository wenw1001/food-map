<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»Šå¤©åƒä»€éº¼ï¼Ÿ | ç¾é£Ÿæ¢éšª</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* ç¹½ç´›æ¼¸å±¤é…è‰² */
            --gradient-bg: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 99%, #FECFEF 100%);
            --gradient-btn: linear-gradient(45deg, #FA8BFF 0%, #2BD2FF 52%, #2BFF88 90%);
            --card-shadow: 0 10px 20px rgba(0,0,0,0.1);
            --main-font: 'Noto Sans TC', sans-serif;
            --accent-color: #FF6B6B;
        }

        body {
            font-family: var(--main-font);
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
            color: #333;
        }

        /* é ‚éƒ¨å½©è‰²å€å¡Š */
        header {
            background: var(--gradient-bg);
            padding: 60px 20px 40px;
            text-align: center;
            border-radius: 0 0 30px 30px;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.2);
        }

        header h1 {
            margin: 0;
            font-size: 2.5rem;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            letter-spacing: 2px;
        }

        header p {
            color: rgba(255,255,255,0.9);
            font-size: 1.1rem;
            margin-top: 10px;
        }

        .container {
            max-width: 600px;
            margin: -30px auto 0; /* è®“å…§å®¹å¾€ä¸Šæµ®å‹• */
            padding: 20px;
            position: relative;
        }

        /* ç¯©é¸å€å¡Šå¡ç‰‡åŒ– */
        .filter-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 1rem;
            color: #888;
            margin-bottom: 15px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* è† å›ŠæŒ‰éˆ•é¸å–® */
        .options-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .options-grid input[type="radio"] {
            display: none;
        }

        .options-grid label {
            padding: 10px 20px;
            border-radius: 50px;
            background: #f0f2f5;
            color: #666;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            font-weight: bold;
        }

        /* é¸ä¸­ç‹€æ…‹ï¼šç¹½ç´›é‚Šæ¡† */
        .options-grid input[type="radio"]:checked + label {
            background: #fff;
            color: #FF6B6B;
            border-color: #FF6B6B;
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.2);
        }

        /* å·¨å¤§çš„ Discover æŒ‰éˆ• */
        .action-btn {
            display: block;
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 50px;
            background: var(--gradient-btn);
            background-size: 200% auto;
            color: white;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(43, 210, 255, 0.3);
            transition: 0.5s;
            margin-top: 20px;
        }

        .action-btn:hover {
            background-position: right center; /* å‹•ç•«æ•ˆæœ */
            transform: translateY(-3px);
        }

        /* è¼‰å…¥ä¸­ */
        .loading {
            text-align: center;
            color: #888;
            display: none;
            padding: 20px;
            font-weight: bold;
        }

        /* çµæœåˆ—è¡¨ */
        #results {
            margin-top: 30px;
        }

        .place-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 16px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            display: flex;
            animation: popIn 0.5s ease forwards;
            opacity: 0;
            transform: scale(0.9);
            border: 1px solid #eee;
        }

        .place-map {
            width: 120px;
            flex-shrink: 0;
            background: #eee;
        }
        
        .place-map img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .place-info {
            padding: 15px;
            flex-grow: 1;
        }

        .place-tags {
            font-size: 0.75rem;
            color: #2BD2FF;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .place-name {
            font-size: 1.2rem;
            margin: 0 0 5px 0;
            color: #333;
        }

        .rating {
            color: #FFB300;
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 10px;
            display: inline-block;
        }

        .meta-info {
            font-size: 0.85rem;
            color: #666;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .go-btn {
            display: inline-block;
            text-decoration: none;
            background: #333;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        @keyframes popIn {
            to { opacity: 1; transform: scale(1); }
        }

        /* æ‰‹æ©Ÿç‰ˆèª¿æ•´ */
        @media (max-width: 600px) {
            header h1 { font-size: 2rem; }
            .place-card { flex-direction: column; }
            .place-map { width: 100%; height: 120px; }
        }
    </style>
</head>
<body>

<header>
    <h1>âœ¨ ä»Šå¤©åƒä»€éº¼ï¼Ÿ</h1>
    <p>ä¸æƒ³æ€è€ƒçš„æ™‚å€™ï¼Œäº¤çµ¦æˆ‘å€‘ä¾†é¸ï¼</p>
</header>

<div class="container">
    
    <div class="filter-card">
        <div class="section-title">ğŸ’° ä½ çš„é ç®—</div>
        <div class="options-grid">
            <input type="radio" name="price" id="p0" value="" checked>
            <label for="p0">éƒ½å¯ä»¥</label>

            <input type="radio" name="price" id="p1" value="1">
            <label for="p1">ğŸ’¸ ä¾¿å®œå°±å¥½</label>

            <input type="radio" name="price" id="p2" value="2">
            <label for="p2">ğŸ’µ è³ªæ„Ÿå°åº—</label>

            <input type="radio" name="price" id="p3" value="3">
            <label for="p3">ğŸ’ ç™¼è–ªæ—¥å¤§é¤</label>
        </div>

        <hr style="border: 0; border-top: 1px dashed #eee; margin: 20px 0;">

        <div class="section-title">ğŸš— äº¤é€šæ–¹å¼</div>
        <div class="options-grid">
            <input type="radio" name="radius" id="r1" value="500">
            <label for="r1">ğŸš¶ èµ°è·¯ (500m)</label>

            <input type="radio" name="radius" id="r2" value="1500" checked>
            <label for="r2">ğŸ›µ é¨è»Š (1.5km)</label>

            <input type="radio" name="radius" id="r3" value="5000">
            <label for="r3">ğŸš• æ­è»Š (5km)</label>
        </div>

        <hr style="border: 0; border-top: 1px dashed #eee; margin: 20px 0;">

        <div class="section-title">ğŸ½ï¸ æƒ³åƒå“ªä¸€é¤</div>
        <div class="options-grid">
            <input type="radio" name="type" id="t_lunch" value="lunch" checked>
            <label for="t_lunch">åˆé¤</label>

            <input type="radio" name="type" id="t_dinner" value="dinner">
            <label for="t_dinner">æ™šé¤</label>

            <input type="radio" name="type" id="t_cafe" value="cafe">
            <label for="t_cafe">å’–å•¡ç”œé»</label>
            
             <input type="radio" name="type" id="t_mid" value="midnight">
            <label for="t_mid">å®µå¤œ</label>
        </div>

        <button class="action-btn" onclick="startDiscovery()">ğŸš€ å¹«æˆ‘æ±ºå®šï¼</button>
    </div>

    <div id="loading" class="loading">
        ğŸ” æ­£åœ¨é›·é”æƒæé™„è¿‘çš„ç¾é£Ÿ...<br>(è«‹è¨˜å¾—æŒ‰ã€Œå…è¨±ã€å®šä½å–”ï¼)
    </div>

    <div id="results"></div>
</div>

<script>
    (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
        key: "AIzaSyAX02p-zEZMVHrIm3Lq-4WhC2EKr5pEki8", 
        v: "weekly",
    });
</script>

<script>
    let userPos = null;
    let placeLib = null;
    let geometryLib = null;
    const apiKey = "AIzaSyAX02p-zEZMVHrIm3Lq-4WhC2EKr5pEki8"; 

    // åˆå§‹åŒ–
    window.onload = function() {
        console.log("ğŸ’¡ ç³»çµ±åˆå§‹åŒ–...");
        
        // æ ¹æ“šæ™‚é–“é é¸
        const hour = new Date().getHours();
        if(hour >= 21 || hour < 5) document.getElementById('t_mid').checked = true;
        else if(hour >= 17) document.getElementById('t_dinner').checked = true;
        else if(hour >= 14) document.getElementById('t_cafe').checked = true;
    };

    async function startDiscovery() {
        console.log("ğŸš€ é–‹å§‹æ¢ç´¢...");
        const loading = document.getElementById('loading');
        const resultsDiv = document.getElementById('results');
        
        // 1. é˜²å‘†æª¢æŸ¥
        if (apiKey.includes("YOUR_API_KEY") || apiKey.length < 10) {
            alert("âš ï¸ è«‹æ›´æ›ç¨‹å¼ç¢¼ä¸­çš„ YOUR_API_KEYï¼");
            return;
        }

        resultsDiv.innerHTML = '';
        loading.style.display = 'block';
        loading.innerHTML = "ğŸ“¡ Step 1: æ­£åœ¨è¼‰å…¥æ–°ç‰ˆåœ°åœ–å…ƒä»¶...";

        try {
            // 2. è¼‰å…¥æ–°ç‰ˆ Libraries (é€™æ˜¯æ–°ç‰ˆ API çš„é—œéµå¯«æ³•)
            if (!placeLib) {
                placeLib = await google.maps.importLibrary("places");
                geometryLib = await google.maps.importLibrary("geometry");
                console.log("âœ… Google Places Library (New) è¼‰å…¥æˆåŠŸ");
            }

            loading.innerHTML = "ğŸ›°ï¸ Step 2: æ­£åœ¨å®šä½ä½ çš„ä½ç½®...";

            // 3. ç€è¦½å™¨å®šä½
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userPos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    console.log("âœ… å®šä½æˆåŠŸ", userPos);
                    searchNewPlaces(userPos);
                },
                (error) => {
                    console.error("å®šä½å¤±æ•—", error);
                    loading.style.display = 'none';
                    alert("âŒ ç„¡æ³•å–å¾—å®šä½ï¼Œè«‹ç¢ºèªç€è¦½å™¨æ¬Šé™ã€‚");
                }
            );

        } catch (e) {
            console.error("API è¼‰å…¥å¤±æ•—", e);
            loading.style.display = 'none';
            alert("âŒ Google Maps API è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Console éŒ¯èª¤è¨Šæ¯ (å¯èƒ½æ˜¯ Key æ²’é–‹é€šæ¬Šé™)");
        }
    }

    async function searchNewPlaces(location) {
        const loading = document.getElementById('loading');
        loading.innerHTML = "ğŸ” Step 3: AI æ­£åœ¨æœå°‹ä¸¦åˆ†æé™„è¿‘åº—å®¶...";
        
        const priceLevel = document.querySelector('input[name="price"]:checked').value;
        const radius = parseInt(document.querySelector('input[name="radius"]:checked').value);
        const type = document.querySelector('input[name="type"]:checked').value;

        // é—œéµå­—é‚è¼¯
        let textQuery = "ç¾é£Ÿ";
        if(type === 'cafe') textQuery = "å’–å•¡å»³ ç”œé»";
        else if(type === 'midnight') textQuery = "å®µå¤œ";
        else if(type === 'lunch') textQuery = "åˆé¤";
        else if(type === 'dinner') textQuery = "æ™šé¤";

        console.log(`æœå°‹æ¢ä»¶: ${textQuery}, åŠå¾‘: ${radius}m`);

        // --- æ–°ç‰ˆ API æœå°‹é‚è¼¯ (Text Search) ---
        // ä½¿ç”¨ Place.searchByText å–ä»£èˆŠçš„ nearbySearch
        const { Place } = placeLib;

        const request = {
            textQuery: textQuery,
            fields: ['displayName', 'location', 'rating', 'userRatingCount', 'businessStatus', 'photos', 'id', 'types'],
            locationBias: {
                center: location,
                radius: radius
            },
            maxResultCount: 8, // æ–°ç‰ˆ API é™åˆ¶
            isOpenNow: true,   // åªæ‰¾ç‡Ÿæ¥­ä¸­
            language: 'zh-TW'
        };

        try {
            const { places } = await Place.searchByText(request);
            
            if (!places || places.length === 0) {
                loading.style.display = 'none';
                alert("ğŸ¥º é™„è¿‘æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„åº—...");
                return;
            }

            console.log(`âœ… æ‰¾åˆ° ${places.length} é–“åº—`, places);

            // ç°¡å–®æ’åº (ç†±é–€åº¦)
            // æ–°ç‰ˆ API çš„ rating æ¬„ä½ç›´æ¥å–ç”¨
            places.sort((a, b) => {
                const scoreA = (a.rating || 0) * (a.userRatingCount || 0);
                const scoreB = (b.rating || 0) * (b.userRatingCount || 0);
                return scoreB - scoreA;
            });

            // å–å‰ 5 å
            const topPlaces = places.slice(0, 5);
            
            // è¨ˆç®—è·é›¢ (Distance Matrix ä¾ç„¶æ²¿ç”¨èˆŠç‰ˆ Serviceï¼Œå› ç‚ºé‚„æ²’å¼·åˆ¶å»¢é™¤)
            calculateDistances(topPlaces);

        } catch (err) {
            console.error("æœå°‹ç™¼ç”ŸéŒ¯èª¤", err);
            loading.style.display = 'none';
            alert("æœå°‹æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message);
        }
    }

    function calculateDistances(places) {
        const loading = document.getElementById('loading');
        loading.innerHTML = "ğŸš— Step 4: æ­£åœ¨è¨ˆç®—äº¤é€šæ™‚é–“...";

        const serviceMatrix = new google.maps.DistanceMatrixService();
        const destinations = places.map(p => p.location); // æ–°ç‰ˆ API çš„ location æ˜¯ LatLng ç‰©ä»¶

        serviceMatrix.getDistanceMatrix({
            origins: [userPos],
            destinations: destinations,
            travelMode: 'DRIVING',
        }, (response, status) => {
            loading.style.display = 'none';
            if (status === 'OK') {
                const elements = response.rows[0].elements;
                places.forEach((place, index) => {
                    place.travelInfo = elements[index];
                });
            }
            renderCards(places);
        });
    }

    function renderCards(places) {
        const container = document.getElementById('results');
        
        places.forEach((place, i) => {
            // æ–°ç‰ˆ API çš„è³‡æ–™çµæ§‹å–å€¼æ–¹å¼ç¨å¾®ä¸åŒ
            const lat = place.location.lat();
            const lng = place.location.lng();
            const name = place.displayName; // æ–°ç‰ˆæ˜¯ displayName
            const rating = place.rating || "New";
            const ratingCount = place.userRatingCount || 0;
            
            // è™•ç†åœ–ç‰‡
            let photoUrl = 'https://via.placeholder.com/300?text=No+Image';
            if (place.photos && place.photos.length > 0) {
                // æ–°ç‰ˆ API å–å¾—åœ–ç‰‡ URL çš„æ–¹æ³•
                photoUrl = place.photos[0].getURI({maxWidth: 400});
            }

            const mapUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${lng}&zoom=15&size=300x300&maptype=roadmap&markers=color:blue|label:Me|${userPos.lat},${userPos.lng}&markers=color:red|${lat},${lng}&key=${apiKey}`;

            let distText = "ğŸ“ è¨ˆç®—ä¸­...";
            if (place.travelInfo && place.travelInfo.distance) {
                distText = `ğŸ“ è·é›¢ ${place.travelInfo.distance.text} â€¢ ğŸš— ç´„ ${place.travelInfo.duration.text}`;
            }

            const navLink = `https://www.google.com/maps/dir/?api=1&origin=${userPos.lat},${userPos.lng}&destination=${lat},${lng}&destination_place_id=${place.id}&travelmode=driving`;

            const html = `
                <div class="place-card" style="animation-delay: ${i * 0.1}s">
                    <div class="place-map">
                        <img src="${mapUrl}" alt="åœ°åœ–é è¦½" onerror="this.src='https://via.placeholder.com/300?text=No+Map'">
                    </div>
                    <div class="place-info">
                        <div class="place-tags">RECOMMEND</div>
                        <h3 class="place-name">${name}</h3>
                        <div class="rating">â˜… ${rating} <span style="color:#aaa;font-weight:normal">(${ratingCount})</span></div>
                        <div class="meta-info">${distText}</div>
                        <a href="${navLink}" target="_blank" class="go-btn">å‰å¾€å°èˆª â”</a>
                    </div>
                </div>
            `;
            container.innerHTML += html;
        });
    }
</script>
</body>
</html>