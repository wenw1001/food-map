<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ± éš¨æ©Ÿç¾é£Ÿç‰¹æ´¾å“¡ | æ‡¶äººæ¨¡å¼ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF4757;
            --secondary: #2F3542;
            --accent: #ffa502;
            --bg: #F8F9FA;
        }

        body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--secondary); }
        header { background: var(--primary); color: white; padding: 40px 20px; text-align: center; border-radius: 0 0 30px 30px; }
        .container { max-width: 650px; margin: -30px auto 50px; padding: 0 15px; }
        .card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); margin-bottom: 20px; }
        
        .section-title { font-size: 1rem; font-weight: bold; margin: 20px 0 10px; color: #57606f; display: block; border-left: 4px solid var(--primary); padding-left: 10px; }
        
        .chip-group { display: flex; flex-wrap: wrap; gap: 8px; }
        .chip-group input { display: none; }
        .chip-group label {
            padding: 8px 16px; border-radius: 50px; background: #eee; 
            cursor: pointer; font-size: 0.85rem; transition: 0.3s; border: 1.5px solid transparent;
        }
        .chip-group input:checked + label { background: #ffeae6; color: var(--primary); border-color: var(--primary); font-weight: bold; }

        .action-btn {
            width: 100%; padding: 18px; border: none; border-radius: 15px;
            background: var(--primary); color: white; font-size: 1.3rem; font-weight: bold;
            cursor: pointer; margin-top: 25px; transition: 0.3s;
        }
        .action-btn:hover { background: #ff6b81; transform: translateY(-2px); }

        .place-item { background: white; border-radius: 20px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .place-content { display: flex; padding: 15px; gap: 15px; }
        .place-map-box { width: 120px; height: 120px; flex-shrink: 0; border-radius: 12px; overflow: hidden; }
        .place-map-box img { width: 100%; height: 100%; object-fit: cover; }
        
        .place-details { flex-grow: 1; }
        .place-name { font-size: 1.15rem; font-weight: bold; margin: 0; }
        .route-summary { font-size: 0.8rem; background: #fffaf0; padding: 6px 10px; border-radius: 8px; margin: 8px 0; border: 1px solid #ffeaa7; }
        
        .directions-box { padding: 15px; border-top: 1px dashed #ddd; font-size: 0.85rem; color: #57606f; display: none; background: #fafafa; }
        .step-item { margin: 8px 0; padding-left: 15px; position: relative; }
        .step-item::before { content: "â€¢"; position: absolute; left: 0; color: var(--primary); }

        .loading { text-align: center; padding: 20px; display: none; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<header>
    <h1>ğŸ² é»é¤æ•‘æ˜Ÿ</h1>
    <p>ä¸æƒ³é¸ï¼Ÿå°±è®“è¡›æ˜Ÿæ±ºå®šä»Šå¤©çš„é©šå–œï¼</p>
</header>

<div class="container">
    <div class="card">
        <span class="section-title">ğŸ¥˜ æˆ‘æƒ³åƒ... (ä¸å‹¾é¸ä»£è¡¨ã€Œéš¨ä¾¿ã€)</span>
        <div class="chip-group">
            <input type="checkbox" id="f1" name="food" value="ç«é‹"><label for="f1">ç«é‹</label>
            <input type="checkbox" id="f2" name="food" value="é¹¹æ°´é›"><label for="f2">é¹¹æ°´é›</label>
            <input type="checkbox" id="f3" name="food" value="æ»·å‘³"><label for="f3">æ»·å‘³</label>
            <input type="checkbox" id="f4" name="food" value="ç‚­çƒ¤ ç‚¸é›"><label for="f4">ç‚¸é›ç‚­çƒ¤</label>
            <input type="checkbox" id="f5" name="food" value="æ‹‰éºµ çƒé¾éºµ"><label for="f5">æ‹‰éºµ</label>
            <input type="checkbox" id="f6" name="food" value="å£½å¸ æ—¥å¼æ–™ç†"><label for="f6">æ—¥æ–™</label>
            <input type="checkbox" id="f7" name="food" value="ç¾©å¤§åˆ©éºµ æŠ«è–©"><label for="f7">ç¾©å¼</label>
            <input type="checkbox" id="f8" name="food" value="ç¾å¼ æ¼¢å ¡"><label for="f8">æ¼¢å ¡</label>
            <input type="checkbox" id="f9" name="food" value="æ‰‹æ–é£² ç”œé»"><label for="f9">é£²æ–™ç”œé»</label>
            <input type="checkbox" id="f10" name="food" value="ä¾¿ç•¶ ç‚’é£¯ éºµé£Ÿ"><label for="f10">å°å¼æ—¥å¸¸</label>
        </div>

        <span class="section-title">ğŸ’° é ç®—</span>
        <div class="chip-group">
            <input type="radio" id="p1" name="budget" value="1"><label for="p1">200å…§</label>
            <input type="radio" id="p2" name="budget" value="2" checked><label for="p2">å¹³åƒ¹</label>
            <input type="radio" id="p3" name="budget" value="3"><label for="p3">ç¨è²´</label>
            <input type="radio" id="p_any" name="budget" value="all"><label for="p_any">ä¸é™é ç®—</label>
        </div>

        <span class="section-title">ğŸš‡ äº¤é€š</span>
        <div class="chip-group">
            <input type="radio" id="m1" name="mode" value="WALKING"><label for="m1">ğŸš¶ èµ°è·¯</label>
            <input type="radio" id="m2" name="mode" value="BICYCLING" checked><label for="m2">ğŸš² é¨è»Š</label>
            <input type="radio" id="m3" name="mode" value="TRANSIT"><label for="m3">ğŸšŒ è½‰ä¹˜</label>
        </div>

        <button class="action-btn" onclick="searchFood()">ğŸš€ éš¨æ©Ÿé¸ä¸€å®¶ï¼</button>
    </div>

    <div id="loading" class="loading">ğŸ“¡ æ­£åœ¨æœå°‹...</div>
    <div id="results"></div>
    <button id="more-btn" style="display:none; width:100%; padding:15px; border:none; background:none; color:var(--primary); font-weight:bold; cursor:pointer;" onclick="displayBatch()">â¬‡ å†çµ¦æˆ‘å¹¾å®¶é¸</button>
</div>

<script>
    (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
        key: "AIzaSyAX02p-zEZMVHrIm3Lq-4WhC2EKr5pEki8", // âš ï¸
        v: "weekly"
    });
</script>

<script>
    let userPos, placeLib, directionsService;
    let pool = [];
    let currentIndex = 0;
    const apiKey = "<strong>YOUR_API_KEY</strong>"; // âš ï¸

    async function searchFood() {
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const moreBtn = document.getElementById('more-btn');
        
        loading.style.display = 'block';
        results.innerHTML = '';
        pool = [];
        currentIndex = 0;
        moreBtn.style.display = 'none';

        if (!placeLib) placeLib = await google.maps.importLibrary("places");
        if (!directionsService) directionsService = new google.maps.DirectionsService();

        navigator.geolocation.getCurrentPosition(async (pos) => {
            userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            
            const foods = Array.from(document.querySelectorAll('input[name="food"]:checked')).map(el => el.value);
            const budgetVal = document.querySelector('input[name="budget"]:checked').value;
            const mode = document.querySelector('input[name="mode"]:checked').value;
            
            // é‚è¼¯ 1: å¦‚æœæ²’é¸é£Ÿç‰©ï¼Œquery è¨­ç‚ºæœ€å»£æ³›çš„ã€Œç¾é£Ÿã€
            const textQuery = foods.length > 0 ? foods.join(" ") : "ç¾é£Ÿ é¤å»³ å°åƒ";
            
            let radius = (mode === "WALKING") ? 1000 : (mode === "BICYCLING" ? 4000 : 12000);

            const { Place } = placeLib;
            
            let request = {
                textQuery: textQuery,
                locationBias: { center: userPos, radius: radius },
                isOpenNow: true,
                fields: ['displayName', 'location', 'rating', 'id', 'userRatingCount'],
                language: 'zh-TW'
            };

            // é‚è¼¯ 2: åªæœ‰åœ¨é¸æ“‡ç‰¹å®šé ç®—æ™‚æ‰åŠ ä¸Šç¯©é¸ï¼Œé¿å…ã€Œä¸é™é ç®—ã€å ±éŒ¯
            if(budgetVal !== "all") {
                request.priceLevels = [parseInt(budgetVal)];
            }

            try {
                const { places } = await Place.searchByText(request);
                
                if (!places || places.length === 0) {
                    // é‚è¼¯ 3: è‡ªå‹•å®¹éŒ¯ - å¦‚æœæ²’çµæœä¸”åŸæœ¬æœ‰é ç®—é™åˆ¶ï¼Œæ”¾å¯¬é ç®—å†æœä¸€æ¬¡
                    if (budgetVal !== "all") {
                        console.log("æ”¾å¯¬æ¢ä»¶é‡æ–°æœå°‹...");
                        delete request.priceLevels;
                        const retry = await Place.searchByText(request);
                        if (!retry.places || retry.places.length === 0) throw "ç„¡çµæœ";
                        pool = retry.places;
                    } else {
                        throw "ç„¡çµæœ";
                    }
                } else {
                    pool = places;
                }
                
                pool = pool.sort(() => Math.random() - 0.5);
                displayBatch();
            } catch (e) {
                loading.style.display = 'none';
                alert("ğŸ¥º é™„è¿‘ä¼¼ä¹æ²’æœ‰æ­£åœ¨ç‡Ÿæ¥­çš„åº—ï¼Œè©¦è‘—åˆ‡æ›ã€Œäº¤é€šæ–¹å¼ã€æ“´å¤§ç¯„åœï¼Œæˆ–å‹¾é¸ä¸åŒé¡åˆ¥çœ‹çœ‹ï¼");
            }
        });
    }

    async function displayBatch() {
        const loading = document.getElementById('loading');
        const moreBtn = document.getElementById('more-btn');
        const mode = document.querySelector('input[name="mode"]:checked').value;
        const batch = pool.slice(currentIndex, currentIndex + 3);

        for (const place of batch) {
            await getRouteData(place, mode);
        }

        currentIndex += 3;
        loading.style.display = 'none';
        if (currentIndex < pool.length) moreBtn.style.display = 'block';
    }

    async function getRouteData(place, mode) {
        return new Promise((resolve) => {
            directionsService.route({
                origin: userPos,
                destination: place.location,
                travelMode: google.maps.TravelMode[mode]
            }, (result, status) => {
                if (status === 'OK') renderCard(place, result.routes[0].legs[0]);
                resolve();
            });
        });
    }

    function renderCard(place, leg) {
        const container = document.getElementById('results');
        const cardId = `route-${place.id}`;
        
        const path = `path=color:0xff4757ff|weight:5|${userPos.lat},${userPos.lng}|${place.location.lat()},${place.location.lng()}`;
        const mapUrl = `https://maps.googleapis.com/maps/api/staticmap?size=260x260&markers=color:blue|label:S|${userPos.lat},${userPos.lng}&markers=color:red|label:E|${place.location.lat()},${place.location.lng()}&${path}&key=${apiKey}`;

        const stepsHtml = leg.steps.map(step => `<div class="step-item">${step.instructions} (${step.distance.text})</div>`).join('');

        const html = `
            <div class="place-item">
                <div class="place-content">
                    <div class="place-map-box"><img src="${mapUrl}"></div>
                    <div class="place-details">
                        <h3 class="place-name">${place.displayName}</h3>
                        <div style="color:var(--accent); font-weight:bold; font-size:0.9rem;">â˜… ${place.rating || 'New'} (${place.userRatingCount || 0})</div>
                        <div class="route-summary"><b>${leg.duration.text}</b> (${leg.distance.text})</div>
                        <div class="toggle-route" onclick="toggleRoute('${cardId}', this)">è©³ç´°è·¯ç·š â–¼</div>
                    </div>
                </div>
                <div id="${cardId}" class="directions-box">
                    ${stepsHtml}
                    <a href="https://www.google.com/maps/dir/?api=1&origin=${userPos.lat},${userPos.lng}&destination=${encodeURIComponent(place.displayName)}&destination_place_id=${place.id}&travelmode=${document.querySelector('input[name="mode"]:checked').value.toLowerCase()}" 
                       target="_blank" style="display:block; margin-top:10px; color:var(--primary); font-weight:bold; text-align:center;">é–‹å•Ÿåœ°åœ–å°èˆª â”</a>
                </div>
            </div>
        `;
        container.innerHTML += html;
    }

    function toggleRoute(id, btn) {
        const box = document.getElementById(id);
        const isOpen = box.style.display === 'block';
        box.style.display = isOpen ? 'none' : 'block';
        btn.innerText = isOpen ? 'è©³ç´°è·¯ç·š â–¼' : 'æ”¶åˆè·¯ç·š â–²';
    }
</script>

</body>
</html>