<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ± å…¨èƒ½ç¾é£Ÿå°èˆªå“¡</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF4757;
            --secondary: #2F3542;
            --bg: #F1F2F6;
        }

        body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--secondary); }
        header { background: var(--primary); color: white; padding: 40px 20px; text-align: center; border-radius: 0 0 30px 30px; }
        .container { max-width: 650px; margin: -30px auto 50px; padding: 0 15px; }
        .card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        .section-title { font-size: 1rem; font-weight: bold; margin: 15px 0 10px; color: #57606f; display: block; }
        
        /* ç¹½ç´›çš„é£Ÿç‰©æ¨™ç±¤ */
        .chip-group { display: flex; flex-wrap: wrap; gap: 8px; }
        .chip-group input { display: none; }
        .chip-group label {
            padding: 8px 16px; border-radius: 50px; background: #f0f0f0; 
            cursor: pointer; font-size: 0.9rem; transition: 0.3s; border: 1.5px solid transparent;
        }
        .chip-group input:checked + label { background: #ffeae6; color: var(--primary); border-color: var(--primary); font-weight: bold; }

        .action-btn {
            width: 100%; padding: 18px; border: none; border-radius: 15px;
            background: var(--primary); color: white; font-size: 1.2rem; font-weight: bold;
            cursor: pointer; margin-top: 25px; transition: 0.3s;
        }
        .action-btn:hover { background: #ff6b81; transform: translateY(-2px); }

        /* åº—å®¶çµæœå¡ç‰‡ */
        .place-item { background: white; border-radius: 20px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .place-content { display: flex; padding: 15px; gap: 15px; }
        .place-map-box { width: 140px; height: 140px; flex-shrink: 0; border-radius: 15px; overflow: hidden; }
        .place-map-box img { width: 100%; height: 100%; object-fit: cover; }
        
        .place-details { flex-grow: 1; }
        .place-name { font-size: 1.2rem; font-weight: bold; margin: 0; }
        .route-summary { font-size: 0.85rem; background: #f8f9fa; padding: 8px; border-radius: 10px; margin: 10px 0; color: #2f3542; }
        
        /* è·¯ç·šæ˜ç´° */
        .directions-box { 
            padding: 0 15px 15px; border-top: 1px solid #eee; 
            font-size: 0.85rem; color: #57606f; display: none; 
        }
        .step-item { margin: 8px 0; padding-left: 20px; position: relative; }
        .step-item::before { content: "â€¢"; position: absolute; left: 0; color: var(--primary); font-weight: bold; }
        
        .toggle-route { color: var(--primary); cursor: pointer; font-size: 0.85rem; font-weight: bold; text-decoration: underline; }

        .loading { text-align: center; padding: 20px; display: none; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<header>
    <h1>ğŸ• ç¾é£Ÿèˆ‡å°èˆªç‰¹æ´¾å“¡</h1>
    <p>é¸å¥½æƒ³åƒçš„èˆ‡äº¤é€šæ–¹å¼ï¼Œæˆ‘å¸¶ä½ å»ï¼</p>
</header>

<div class="container">
    <div class="card">
        <span class="section-title">ğŸœ æˆ‘æƒ³åƒ... (å¯å¤šé¸)</span>
        <div class="chip-group">
            <input type="checkbox" id="f1" name="food" value="ç«é‹" checked><label for="f1">ç«é‹</label>
            <input type="checkbox" id="f2" name="food" value="ç‡’è‚‰"><label for="f2">ç‡’è‚‰</label>
            <input type="checkbox" id="f3" name="food" value="æ‹‰éºµ"><label for="f3">æ‹‰éºµ</label>
            <input type="checkbox" id="f4" name="food" value="ç¾©å¤§åˆ©éºµ"><label for="f4">ç¾©å¼</label>
            <input type="checkbox" id="f5" name="food" value="å£½å¸ æ—¥å¼"><label for="f5">æ—¥æ–™</label>
            <input type="checkbox" id="f6" name="food" value="æ¼¢å ¡ ç¾å¼"><label for="f6">ç¾å¼</label>
            <input type="checkbox" id="f7" name="food" value="æ—©åˆé¤"><label for="f7">æ—©åˆé¤</label>
            <input type="checkbox" id="f8" name="food" value="å±…é…’å±‹"><label for="f8">å±…é…’å±‹</label>
            <input type="checkbox" id="f9" name="food" value="å’–å•¡å»³ ç”œé»"><label for="f9">ç”œé»å’–å•¡</label>
            <input type="checkbox" id="f10" name="food" value="éŸ“å¼æ–™ç†"><label for="f10">éŸ“å¼</label>
            <input type="checkbox" id="f11" name="food" value="æ³°å¼æ–™ç†"><label for="f11">æ³°å¼</label>
            <input type="checkbox" id="f12" name="food" value="ç‰›æ’"><label for="f12">ç‰›æ’</label>
            <input type="checkbox" id="f13" name="food" value="ç´ é£Ÿ"><label for="f13">è”¬é£Ÿç´ é£Ÿ</label>
            <input type="checkbox" id="f14" name="food" value="é…’å§"><label for="f14">é…’å§</label>
            <input type="checkbox" id="f15" name="food" value="æ»·å‘³ å®µå¤œ"><label for="f15">å®µå¤œé»å¿ƒ</label>
            <input type="checkbox" id="f16" name="food" value="é¤é…’é¤¨"><label for="f16">é¤é…’é¤¨</label>
        </div>

        <span class="section-title">ğŸš‡ äº¤é€šæ–¹å¼èˆ‡ç¯„åœ</span>
        <div class="chip-group">
            <input type="radio" id="m1" name="mode" value="WALKING" checked><label for="m1">ğŸš¶ èµ°è·¯ (1kmå…§)</label>
            <input type="radio" id="m2" name="mode" value="BICYCLING"><label for="m2">ğŸš² é¨è»Š (5kmå…§)</label>
            <input type="radio" id="m3" name="mode" value="TRANSIT"><label for="m3">ğŸšŒ è½‰ä¹˜å¤§çœ¾é‹è¼¸ (15km)</label>
        </div>

        <button class="action-btn" onclick="searchFood()">ğŸš€ å°‹æ‰¾ä¸¦è¦åŠƒè·¯ç·š</button>
    </div>

    <div id="loading" class="loading">ğŸ“¡ æ­£åœ¨é€£æ¥è¡›æ˜Ÿä¸¦è¦åŠƒè·¯ç·š...</div>
    <div id="results"></div>
    <button id="more-btn" style="display:none; width:100%; padding:15px; border:none; background:none; color:var(--primary); font-weight:bold; cursor:pointer;" onclick="displayBatch()">â¬‡ é¡¯ç¤ºæ›´å¤šéš¨æ©Ÿæ¨è–¦</button>
</div>

<script>
    (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
        key: "YOUR_API_KEY", // âš ï¸ æ›¿æ›ç‚ºä½ çš„ API Key
        v: "weekly"
    });
</script>

<script>
    let userPos, placeLib, directionsService;
    let pool = [];
    let currentIndex = 0;
    const apiKey = "YOUR_API_KEY"; // âš ï¸ æ›¿æ›ç‚ºä½ çš„ API Key

    async function searchFood() {
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const moreBtn = document.getElementById('more-btn');
        
        loading.style.display = 'block';
        results.innerHTML = '';
        moreBtn.style.display = 'none';
        pool = [];
        currentIndex = 0;

        if (!placeLib) placeLib = await google.maps.importLibrary("places");
        if (!directionsService) directionsService = new google.maps.DirectionsService();

        navigator.geolocation.getCurrentPosition(async (pos) => {
            userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            
            const foods = Array.from(document.querySelectorAll('input[name="food"]:checked')).map(el => el.value);
            const mode = document.querySelector('input[name="mode"]:checked').value;
            
            let radius = 1000;
            if (mode === "BICYCLING") radius = 5000;
            if (mode === "TRANSIT") radius = 15000;

            const { Place } = placeLib;
            const request = {
                textQuery: foods.join(" "),
                locationBias: { center: userPos, radius: radius },
                isOpenNow: true,
                fields: ['displayName', 'location', 'rating', 'id']
            };

            try {
                const { places } = await Place.searchByText(request);
                if (!places || places.length === 0) throw "ç„¡çµæœ";
                
                // éš¨æ©Ÿæ‰“äº‚
                pool = places.sort(() => Math.random() - 0.5);
                displayBatch();
            } catch (e) {
                alert("é™„è¿‘æ‰¾ä¸åˆ°é€™äº›é¡å‹çš„ç‡Ÿæ¥­ä¸­é¤å»³å–”ï¼");
                loading.style.display = 'none';
            }
        });
    }

    async function displayBatch() {
        const loading = document.getElementById('loading');
        const moreBtn = document.getElementById('more-btn');
        const mode = document.querySelector('input[name="mode"]:checked').value;
        const batch = pool.slice(currentIndex, currentIndex + 3); // æ¯æ¬¡é¡¯ç¤º3ç­†ï¼Œå› ç‚ºå°èˆª API è¼ƒé‡

        for (const place of batch) {
            await getRouteData(place, mode);
        }

        currentIndex += 3;
        loading.style.display = 'none';
        if (currentIndex < pool.length) moreBtn.style.display = 'block';
    }

    async function getRouteData(place, mode) {
        return new Promise((resolve) => {
            directionsService.route({
                origin: userPos,
                destination: place.location,
                travelMode: google.maps.TravelMode[mode]
            }, (result, status) => {
                if (status === 'OK') {
                    renderCard(place, result.routes[0].legs[0]);
                }
                resolve();
            });
        });
    }

    function renderCard(place, leg) {
        const container = document.getElementById('results');
        const cardId = `route-${place.id}`;
        
        // è£½ä½œåœ°åœ–è·¯å¾‘ URL
        const path = `path=color:0xff4757ff|weight:5|${userPos.lat},${userPos.lng}|${place.location.lat()},${place.location.lng()}`;
        const mapUrl = `https://maps.googleapis.com/maps/api/staticmap?size=300x300&markers=color:blue|label:S|${userPos.lat},${userPos.lng}&markers=color:red|label:E|${place.location.lat()},${place.location.lng()}&${path}&key=${apiKey}`;

        // æ•´ç†è·¯ç·šæ­¥é©Ÿ
        const stepsHtml = leg.steps.map(step => `<div class="step-item">${step.instructions} (${step.distance.text})</div>`).join('');

        const html = `
            <div class="place-item">
                <div class="place-content">
                    <div class="place-map-box">
                        <img src="${mapUrl}">
                    </div>
                    <div class="place-details">
                        <h3 class="place-name">${place.displayName}</h3>
                        <div style="color:#ff9f43; font-weight:bold;">â˜… ${place.rating || 'æ–°é–‹å¹•'}</div>
                        <div class="route-summary">
                            â±ï¸ é è¨ˆï¼š<b>${leg.duration.text}</b> (${leg.distance.text})<br>
                            ğŸ‘£ æ–¹å¼ï¼š${getModeIcon()}
                        </div>
                        <div class="toggle-route" onclick="document.getElementById('${cardId}').style.display='block'; this.style.display='none'">æŸ¥çœ‹è©³ç´°èµ°æ³• â–¼</div>
                    </div>
                </div>
                <div id="${cardId}" class="directions-box">
                    <p><b>å…·é«”è·¯ç·šå¼•å°ï¼š</b></p>
                    ${stepsHtml}
                    <a href="https://www.google.com/maps/dir/?api=1&origin=${userPos.lat},${userPos.lng}&destination_place_id=${place.id}&travelmode=${document.querySelector('input[name="mode"]:checked').value.toLowerCase()}" 
                       target="_blank" style="display:block; margin-top:10px; color:var(--primary); font-weight:bold; text-decoration:none;">é–‹å•Ÿ Google Maps å°èˆª â”</a>
                </div>
            </div>
        `;
        container.innerHTML += html;
    }

    function getModeIcon() {
        const mode = document.querySelector('input[name="mode"]:checked').value;
        if (mode === 'WALKING') return "èµ°è·¯";
        if (mode === 'BICYCLING') return "é¨ä¹˜";
        return "å¤§çœ¾é‹è¼¸";
    }
</script>

</body>
</html>