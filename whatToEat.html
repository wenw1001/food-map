<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»Šå¤©åƒä»€éº¼ï¼Ÿ | ç¾é£Ÿæ¢éšª</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* ç¹½ç´›æ¼¸å±¤é…è‰² */
            --gradient-bg: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 99%, #FECFEF 100%);
            --gradient-btn: linear-gradient(45deg, #FA8BFF 0%, #2BD2FF 52%, #2BFF88 90%);
            --card-shadow: 0 10px 20px rgba(0,0,0,0.1);
            --main-font: 'Noto Sans TC', sans-serif;
            --accent-color: #FF6B6B;
        }

        body {
            font-family: var(--main-font);
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
            color: #333;
        }

        /* é ‚éƒ¨å½©è‰²å€å¡Š */
        header {
            background: var(--gradient-bg);
            padding: 60px 20px 40px;
            text-align: center;
            border-radius: 0 0 30px 30px;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.2);
        }

        header h1 {
            margin: 0;
            font-size: 2.5rem;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            letter-spacing: 2px;
        }

        header p {
            color: rgba(255,255,255,0.9);
            font-size: 1.1rem;
            margin-top: 10px;
        }

        .container {
            max-width: 600px;
            margin: -30px auto 0; /* è®“å…§å®¹å¾€ä¸Šæµ®å‹• */
            padding: 20px;
            position: relative;
        }

        /* ç¯©é¸å€å¡Šå¡ç‰‡åŒ– */
        .filter-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 1rem;
            color: #888;
            margin-bottom: 15px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* è† å›ŠæŒ‰éˆ•é¸å–® */
        .options-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .options-grid input[type="radio"] {
            display: none;
        }

        .options-grid label {
            padding: 10px 20px;
            border-radius: 50px;
            background: #f0f2f5;
            color: #666;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            font-weight: bold;
        }

        /* é¸ä¸­ç‹€æ…‹ï¼šç¹½ç´›é‚Šæ¡† */
        .options-grid input[type="radio"]:checked + label {
            background: #fff;
            color: #FF6B6B;
            border-color: #FF6B6B;
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.2);
        }

        /* å·¨å¤§çš„ Discover æŒ‰éˆ• */
        .action-btn {
            display: block;
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 50px;
            background: var(--gradient-btn);
            background-size: 200% auto;
            color: white;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(43, 210, 255, 0.3);
            transition: 0.5s;
            margin-top: 20px;
        }

        .action-btn:hover {
            background-position: right center; /* å‹•ç•«æ•ˆæœ */
            transform: translateY(-3px);
        }

        /* è¼‰å…¥ä¸­ */
        .loading {
            text-align: center;
            color: #888;
            display: none;
            padding: 20px;
            font-weight: bold;
        }

        /* çµæœåˆ—è¡¨ */
        #results {
            margin-top: 30px;
        }

        .place-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 16px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            display: flex;
            animation: popIn 0.5s ease forwards;
            opacity: 0;
            transform: scale(0.9);
            border: 1px solid #eee;
        }

        .place-map {
            width: 120px;
            flex-shrink: 0;
            background: #eee;
        }
        
        .place-map img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .place-info {
            padding: 15px;
            flex-grow: 1;
        }

        .place-tags {
            font-size: 0.75rem;
            color: #2BD2FF;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .place-name {
            font-size: 1.2rem;
            margin: 0 0 5px 0;
            color: #333;
        }

        .rating {
            color: #FFB300;
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 10px;
            display: inline-block;
        }

        .meta-info {
            font-size: 0.85rem;
            color: #666;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .go-btn {
            display: inline-block;
            text-decoration: none;
            background: #333;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        @keyframes popIn {
            to { opacity: 1; transform: scale(1); }
        }

        /* æ‰‹æ©Ÿç‰ˆèª¿æ•´ */
        @media (max-width: 600px) {
            header h1 { font-size: 2rem; }
            .place-card { flex-direction: column; }
            .place-map { width: 100%; height: 120px; }
        }
    </style>
</head>
<body>

<header>
    <h1>âœ¨ ä»Šå¤©åƒä»€éº¼ï¼Ÿ</h1>
    <p>ä¸æƒ³æ€è€ƒçš„æ™‚å€™ï¼Œäº¤çµ¦æˆ‘å€‘ä¾†é¸ï¼</p>
</header>

<div class="container">
    
    <div class="filter-card">
        <div class="section-title">ğŸ’° ä½ çš„é ç®—</div>
        <div class="options-grid">
            <input type="radio" name="price" id="p0" value="" checked>
            <label for="p0">éƒ½å¯ä»¥</label>

            <input type="radio" name="price" id="p1" value="1">
            <label for="p1">ğŸ’¸ ä¾¿å®œå°±å¥½</label>

            <input type="radio" name="price" id="p2" value="2">
            <label for="p2">ğŸ’µ è³ªæ„Ÿå°åº—</label>

            <input type="radio" name="price" id="p3" value="3">
            <label for="p3">ğŸ’ ç™¼è–ªæ—¥å¤§é¤</label>
        </div>

        <hr style="border: 0; border-top: 1px dashed #eee; margin: 20px 0;">

        <div class="section-title">ğŸš— äº¤é€šæ–¹å¼</div>
        <div class="options-grid">
            <input type="radio" name="radius" id="r1" value="500">
            <label for="r1">ğŸš¶ èµ°è·¯ (500m)</label>

            <input type="radio" name="radius" id="r2" value="1500" checked>
            <label for="r2">ğŸ›µ é¨è»Š (1.5km)</label>

            <input type="radio" name="radius" id="r3" value="5000">
            <label for="r3">ğŸš• æ­è»Š (5km)</label>
        </div>

        <hr style="border: 0; border-top: 1px dashed #eee; margin: 20px 0;">

        <div class="section-title">ğŸ½ï¸ æƒ³åƒå“ªä¸€é¤</div>
        <div class="options-grid">
            <input type="radio" name="type" id="t_lunch" value="lunch" checked>
            <label for="t_lunch">åˆé¤</label>

            <input type="radio" name="type" id="t_dinner" value="dinner">
            <label for="t_dinner">æ™šé¤</label>

            <input type="radio" name="type" id="t_cafe" value="cafe">
            <label for="t_cafe">å’–å•¡ç”œé»</label>
            
             <input type="radio" name="type" id="t_mid" value="midnight">
            <label for="t_mid">å®µå¤œ</label>
        </div>

        <button class="action-btn" onclick="startDiscovery()">ğŸš€ å¹«æˆ‘æ±ºå®šï¼</button>
    </div>

    <div id="loading" class="loading">
        ğŸ” æ­£åœ¨é›·é”æƒæé™„è¿‘çš„ç¾é£Ÿ...<br>(è«‹è¨˜å¾—æŒ‰ã€Œå…è¨±ã€å®šä½å–”ï¼)
    </div>

    <div id="results"></div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAX02p-zEZMVHrIm3Lq-4WhC2EKr5pEki8&libraries=places,geometry"></script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAX02p-zEZMVHrIm3Lq-4WhC2EKr5pEki8&libraries=places,geometry"></script>

<script>
    let userPos = null;
    let service;
    const apiKey = "AIzaSyAX02p-zEZMVHrIm3Lq-4WhC2EKr5pEki8"; // âš ï¸ é€™è£¡ä¹Ÿè¦æ›

    // åˆå§‹åŒ–
    window.onload = function() {
        console.log("ğŸ’¡ ç¶²é è¼‰å…¥å®Œæˆ (Step 0)");
        
        // æª¢æŸ¥ Google Maps API æ˜¯å¦æˆåŠŸè¼‰å…¥
        if (typeof google === 'object' && typeof google.maps === 'object') {
            console.log("âœ… Google Maps API å·²å°±ç·’");
        } else {
            console.error("âŒ Google Maps API å°šæœªè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ API Key æˆ–ç¶²è·¯é€£ç·š");
            alert("Google Maps API è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Console");
        }

        const hour = new Date().getHours();
        if(hour >= 21 || hour < 5) document.getElementById('t_mid').checked = true;
        else if(hour >= 17) document.getElementById('t_dinner').checked = true;
        else if(hour >= 14) document.getElementById('t_cafe').checked = true;
    };

    function startDiscovery() {
        console.log("ğŸš€ æŒ‰éˆ•è¢«é»æ“Šäº† (Step 1)");
        
        // 1. æª¢æŸ¥ API Key
        if (apiKey.includes("YOUR_API_KEY") || apiKey.length < 10) {
            console.error("âŒ API Key æœªè¨­å®š");
            alert("âš ï¸ è«‹å°‡ç¨‹å¼ç¢¼ä¸­çš„ YOUR_API_KEY æ›æˆçœŸæ­£çš„é‡‘é‘°ï¼");
            return;
        }

        const loading = document.getElementById('loading');
        const resultsDiv = document.getElementById('results');
        
        resultsDiv.innerHTML = '';
        loading.style.display = 'block';
        loading.innerHTML = "ğŸ“¡ Step 1: æ­£åœ¨è«‹æ±‚å®šä½æ¬Šé™...<br>(è«‹çœ‹ç€è¦½å™¨å·¦ä¸Šè§’æ˜¯å¦æœ‰å½ˆå‡ºè¦–çª—)";

        // 2. æª¢æŸ¥ç€è¦½å™¨å®šä½åŠŸèƒ½
        if (!navigator.geolocation) {
            console.error("âŒ ç€è¦½å™¨ä¸æ”¯æ´ Geolocation");
            alert("ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½");
            return;
        }

        console.log("ğŸ“¡ Step 2: é–‹å§‹å‘¼å« navigator.geolocation.getCurrentPosition...");

        // è¨­å®šå®šä½é¸é … (è¨­å®š timeout é¿å…ç„¡é™ç­‰å¾…)
        const geoOptions = {
            enableHighAccuracy: true,
            timeout: 10000, // 10ç§’å¾Œå¦‚æœæ²’å®šä½åˆ°å°±å ±éŒ¯
            maximumAge: 0
        };

        navigator.geolocation.getCurrentPosition(
            (position) => {
                // --- å®šä½æˆåŠŸ ---
                console.log("âœ… Step 3: å®šä½æˆåŠŸï¼", position);
                loading.innerHTML = "ğŸ—ºï¸ Step 3: å®šä½æˆåŠŸï¼æ­£åœ¨å‘ Google æŸ¥è©¢åº—å®¶...";
                
                userPos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                // å‘¼å« Google æœå°‹
                searchPlaces(userPos);
            },
            (error) => {
                // --- å®šä½å¤±æ•— ---
                console.error("âŒ Step 3: å®šä½å¤±æ•— (Error Callback)", error);
                loading.style.display = 'none';
                
                let errorMsg = "å®šä½å¤±æ•—";
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMsg = "âŒ ä½ æ‹’çµ•äº†å®šä½æ¬Šé™ã€‚è«‹åœ¨ç¶²å€åˆ—å·¦é‚Šçš„é–é ­åœ–ç¤ºé–‹å•Ÿæ¬Šé™ã€‚";
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMsg = "âŒ ç„¡æ³•åµæ¸¬ç›®å‰ä½ç½® (GPS ä¿¡è™Ÿå¾®å¼±)ã€‚";
                        break;
                    case error.TIMEOUT:
                        errorMsg = "âŒ å®šä½é€¾æ™‚ (Timeout)ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– GPSã€‚";
                        break;
                    default:
                        errorMsg = "âŒ æœªçŸ¥éŒ¯èª¤: " + error.message;
                }
                alert(errorMsg);
            },
            geoOptions
        );
    }

    function searchPlaces(location) {
        console.log("ğŸ” Step 4: æº–å‚™å‘¼å« Google Places API...", location);
        
        if (!window.google || !window.google.maps) {
            console.error("âŒ Google Maps ç‰©ä»¶ä¸å­˜åœ¨ï¼Œç„¡æ³•æœå°‹");
            return;
        }

        const dummyMap = new google.maps.Map(document.createElement('div'));
        service = new google.maps.places.PlacesService(dummyMap);

        const priceLevel = document.querySelector('input[name="price"]:checked').value;
        const radius = document.querySelector('input[name="radius"]:checked').value;
        const type = document.querySelector('input[name="type"]:checked').value;

        // é—œéµå­—é‚è¼¯
        let keyword = 'ç¾é£Ÿ';
        if(type === 'cafe') keyword = 'å’–å•¡å»³ ç”œé»';
        else if(type === 'midnight') keyword = 'å®µå¤œ';
        else if(type === 'lunch') keyword = 'åˆé¤';
        else if(type === 'dinner') keyword = 'æ™šé¤';

        const request = {
            location: location,
            radius: radius,
            keyword: keyword,
            type: ['restaurant', 'food'],
            openNow: true
        };

        console.log("ğŸ“¤ ç™¼é€ API Request åƒæ•¸:", request);

        service.nearbySearch(request, (results, status) => {
            console.log("ğŸ“¥ Google API å›å‚³ç‹€æ…‹:", status);
            
            if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
                console.log(`âœ… æ‰¾åˆ° ${results.length} ç­†è³‡æ–™`);
                
                // æ’åº
                results.sort((a, b) => (b.user_ratings_total * b.rating) - (a.user_ratings_total * a.rating));
                const topPlaces = results.slice(0, 5);
                
                calculateDistances(topPlaces);
            } else {
                console.warn("âš ï¸ Google API å›å‚³ OK ä½†æ²’æœ‰çµæœï¼Œæˆ–ç‹€æ…‹é OK");
                document.getElementById('loading').style.display = 'none';
                
                if (status === 'ZERO_RESULTS') {
                    alert("ğŸ¥º å“å‘€ï¼Œé€™é™„è¿‘ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶åˆç‡Ÿæ¥­ä¸­çš„åº—...");
                } else {
                    alert("Google API éŒ¯èª¤: " + status + "\n(è«‹æª¢æŸ¥ Console è©³æƒ…)");
                }
            }
        });
    }

    function calculateDistances(places) {
        console.log("ğŸš— Step 5: è¨ˆç®—è·é›¢ (Distance Matrix)...");
        const serviceMatrix = new google.maps.DistanceMatrixService();
        const destinations = places.map(p => p.geometry.location);

        serviceMatrix.getDistanceMatrix({
            origins: [userPos],
            destinations: destinations,
            travelMode: 'DRIVING',
        }, (response, status) => {
            console.log("ğŸ“¥ è·é›¢è¨ˆç®—å›å‚³:", status);
            document.getElementById('loading').style.display = 'none';
            
            if (status === 'OK') {
                const elements = response.rows[0].elements;
                places.forEach((place, index) => {
                    place.travelInfo = elements[index];
                });
                renderCards(places);
            } else {
                console.warn("âš ï¸ è·é›¢è¨ˆç®—å¤±æ•—ï¼Œä»é¡¯ç¤ºå¡ç‰‡");
                renderCards(places);
            }
        });
    }

    function renderCards(places) {
        console.log("ğŸ¨ Step 6: é–‹å§‹ç¹ªè£½å¡ç‰‡");
        const container = document.getElementById('results');

        places.forEach((place, i) => {
            const mapUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${place.geometry.location.lat()},${place.geometry.location.lng()}&zoom=15&size=300x300&maptype=roadmap&markers=color:blue|label:Me|${userPos.lat},${userPos.lng}&markers=color:red|${place.geometry.location.lat()},${place.geometry.location.lng()}&key=${apiKey}`;

            // å®‰å…¨æª¢æŸ¥ï¼šç¢ºèª travelInfo å­˜åœ¨
            let distText = "ğŸ“ è¨ˆç®—ä¸­...";
            if (place.travelInfo && place.travelInfo.distance) {
                distText = `ğŸ“ è·é›¢ ${place.travelInfo.distance.text} â€¢ ğŸš— ç´„ ${place.travelInfo.duration.text}`;
            }

            const navLink = `https://www.google.com/maps/dir/?api=1&origin=${userPos.lat},${userPos.lng}&destination_place_id=${place.place_id}&travelmode=driving`;

            const html = `
                <div class="place-card" style="animation-delay: ${i * 0.1}s">
                    <div class="place-map">
                        <img src="${mapUrl}" alt="åœ°åœ–é è¦½" onerror="this.src='https://via.placeholder.com/300?text=No+Map'">
                    </div>
                    <div class="place-info">
                        <div class="place-tags">RESTAURANT</div>
                        <h3 class="place-name">${place.name}</h3>
                        <div class="rating">â˜… ${place.rating} <span style="color:#aaa;font-weight:normal">(${place.user_ratings_total})</span></div>
                        <div class="meta-info">${distText}</div>
                        <a href="${navLink}" target="_blank" class="go-btn">å‰å¾€å°èˆª â”</a>
                    </div>
                </div>
            `;
            container.innerHTML += html;
        });
    }
</script>

</body>
</html>